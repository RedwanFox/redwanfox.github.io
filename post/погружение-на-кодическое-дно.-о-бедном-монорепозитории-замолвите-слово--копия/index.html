<!DOCTYPE html>
<html lang="ru-ru">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Погружение на кодическое дно. О бедном монорепозитории замолвите слово. | Power Of The Sword Derivative</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">Home</a></li>
      
      <li><a href="/tags/">Tags</a></li>
      
      <li><a href="/about/">About</a></li>
      
    </ul>
    <hr/>
    </nav>


<div class="article-meta">
<h1><span class="title">Погружение на кодическое дно. О бедном монорепозитории замолвите слово.</span></h1>

<h2 class="date">2022/01/15</h2>
<p class="terms">
  
  
  
  
  Tags: <a href="/tags/%D1%80%D0%B0%D0%B7%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B0">разработка</a> 
  
  
</p>
</div>


<main>
<p>Дисклеймер: Пост родился из трепа в соседнем чате. На пальцах о том, как хранятся (и пылятся) мои домашние проекты.</p>
<p>Меня в какой-то достаточно давний момент задолбало, что мои наработки или теряются или фрагментированы, и я не могу сослаться с одной поделки на другую и приходится или файлы копировать туда-сюда или артефактами бросаться.</p>
<p>Оба варианта приводят к проблемам - кучу телодвижений надо делать заново, копируемые компоненты мутируют по-разному в каждой репе и надо синхронизировать между собой.</p>
<p>Было решено делать монорепозиторий*.</p>
<p>Делал несколько подходов за последние несколько лет, но каждый раз сдавался из-за того, что с самого начала ставил себе непосильную задачу все сделать правильно - все зависимости завендорены, единая система сборки. детально прописанный тулчейн, кроссплатформенность сборки сразу - и других причин (лень, подводные камни bazel, прочая сволочь).</p>
<p>Весной уже прошлого года я решил сделать roguelike демку на godot и godot-rust. Весьма быстро понял, что на rust с таким API писать слишком геморно, а ввязываться плотно в разработку библиотеки не хотелось, и перекинул библиотеку на c++ и cmake из говна и палок. Следом туда заехали наработки из других моих помоек, потом еще и еще, потом в паре мест прикрутил еще кодогенерацию на питоне. потом github actions для per-commit сборок на линухах и маке**.</p>
<p>Опа, опа, у меня оказался относительно причесанный маленький монорепозиторий со всем почти моим барахлом и thirdparty зависимостями, приехавшими через git submodules.</p>
<p>Как обычно в таких случаях много подводных камней:</p>
<ol>
<li>Гитсабмодули ебанутые. особенно весело, когда сабмодуль имеет свои сабмодули.</li>
<li>CMake - CMake не подходит для монорепозиториев и не подходит для sparse checkout на билдерах, и еще для дохрена чего не подходит. моя эпопея с кодогенератором на шланге застопарилась именно на нем.</li>
<li>Кодогенерация. CMake ничего не знает про python, про многофайловые питоновские проекты и про выставление ENV для конкретной команды. Поэтому я сделал ужасное и обернул свои питоновские скрипты в таргеты bazel и начал дергать их через bazel одной командой из cmake. При этом если команда крашится с ошибкой CMake не жрет коды возврата и не роняет таргет.</li>
</ol>
<p>Итого у меня есть: unholy связка билд систем cmake + bazel с кодогенерацией на python, использующей libclang и LALR сгенеренные парсеры. Все великие в обнимку захлебываются в собственной блевотине, как говорил один персонаж из фильма.</p>
<p>В идеале перетащить бы это целиком на bazel, но там начинаются свои проблемы с подключением кодогенерации, а еще там перестает один из проектов собираться о причине того, что я потерял какой-то define thirdparty либы в кастомном скрипте сборки на bazel, и левый код и макросы начинают протекать в мою либу и билд падает на дабл дефинишенах и переопределениях логики.</p>
<p>При всем при этом жить и поддерживать все стало значительно легче и домашние наработки перестали пропадать втуне.</p>
<ul>
<li>хороший доклад про преимущества монореп тут <a href="https://www.youtube.com/watch?v=W71BTkUbdqE">https://www.youtube.com/watch?v=W71BTkUbdqE</a>, на случай, если кому-то интересно.</li>
</ul>
<p>** мак потом пришлось отключить - выяснилось, что при бесплатной квоте 1000 минут процессорного времени на gihub, одну минуту на маке считают за 10.</p>

</main>

  <footer>
  
  
  <hr/>
  © <a href="https://github.com/RedwanFox">Github</a> | <a href="https://t.me/power_of_the_sword_derivative">Telegram</a>
  
  </footer>
  </body>
</html>

